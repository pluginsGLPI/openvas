<?php
/* @version $Id$
--------------------------------------------------------------------------
LICENSE

 This file is part of the openvas plugin.

OpenVAS plugin is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

openvas plugin is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with GLPI; along with openvas. If not, see <http://www.gnu.org/licenses/>.
--------------------------------------------------------------------------
@package   openvas
@author    Teclib'
@copyright Copyright (c) 2016 Teclib'
@license   GPLv3
           http://www.gnu.org/licenses/gpl.txt
@link      https://github.com/pluginsGLPI/openvas
@link      http://www.glpi-project.org/
@link      http://www.teclib-edition.com/
@since     2016
----------------------------------------------------------------------*/

if (!defined('GLPI_ROOT')){
   die("Sorry. You can't access directly to this file");
}


/// Class RequestType
class PluginOpenvasVulnerabilityCategory extends CommonTreeDropdown {

   // From CommonDBTM
   public $dohistory          = true;
   public $can_be_translated  = true;

   static $rightname          = 'plugin_openvas_vulnerability';

   static function getTypeName($nb=0) {
      return __('Vulnerability category', 'openvas');
   }

   function getAdditionalFields() {
      $tab = array(array('name'      => $this->getForeignKeyField(),
                          'label'     => __('As child of'),
                          'type'      => 'parent',
                          'list'      => false),
                    array('name'      => 'knowbaseitemcategories_id',
                          'label'     => __('Knowledge base'),
                          'type'      => 'dropdownValue',
                          'list'      => true)
                   );
      return $tab;
   }

   function getSearchOptions() {

      $tab                = parent::getSearchOptions();
      $tab[79]['table']   = 'glpi_knowbaseitemcategories';
      $tab[79]['field']   = 'completename';
      $tab[79]['name']    = __('Knowledge base');
      $tab[79]['datatype'] = 'dropdown';

      return $tab;
   }

   /**
   * Get links to Faq
   *
   * @param $withname  boolean  also display name ? (false by default)
   */
   static function addKBIcon($categories_id) {
      global $CFG_GLPI;

      $cat = new self();
      if (!$cat->getFromDB($categories_id)) {
        return '';
      }

      $ret = '';

      if ($cat->fields['knowbaseitemcategories_id']) {
         $title = __('Knowledge base');
         $ret .= "<a href='".$CFG_GLPI["root_doc"].
                   "/front/knowbaseitem.php?knowbaseitemcategories_id=".
                   $cat->fields['knowbaseitemcategories_id']."'>".
                 "<img src='".$CFG_GLPI["root_doc"]."/pics/faqadd.png' class='middle'
                   alt=\"$title\" title=\"$title\"></a>";
      }
      return $ret;
   }

   //----------------- Install & uninstall -------------------//
   public static function install(Migration $migration) {
      global $DB;

      //This class is available since version 1.3.0
      if (!TableExists("glpi_plugin_openvas_vulnerabilitycategories")) {
         $migration->displayMessage("Install glpi_plugin_openvas_vulnerabilitycategories");

         $config = new self();

         //Install
         $query = "CREATE TABLE `glpi_plugin_openvas_vulnerabilitycategories` (
           `id` int(11) NOT NULL AUTO_INCREMENT,
           `entities_id` int(11) NOT NULL DEFAULT '0',
           `is_recursive` tinyint(1) NOT NULL DEFAULT '0',
           `name` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,
           `plugin_openvas_vulnerabilitycategories_id` int(11) NOT NULL DEFAULT '0',
           `comment` text COLLATE utf8_unicode_ci,
           `states_id` int(11) NOT NULL DEFAULT '0',
           `completename` text COLLATE utf8_unicode_ci,
           `level` int(11) NOT NULL DEFAULT '0',
           `ancestors_cache` longtext COLLATE utf8_unicode_ci,
           `sons_cache` longtext COLLATE utf8_unicode_ci,
           `knowbaseitemcategories_id` int(11) NOT NULL DEFAULT '0',
           `date_mod` datetime DEFAULT NULL,
           `date_creation` datetime DEFAULT NULL,
           PRIMARY KEY (`id`),
           KEY `name` (`name`),
           KEY `entities_id` (`entities_id`),
           KEY `knowbaseitemcategories_id` (`knowbaseitemcategories_id`),
           KEY `unicity` (`plugin_openvas_vulnerabilitycategories_id`,`name`),
           KEY `date_mod` (`date_mod`),
           KEY `date_creation` (`date_creation`)
         ) ENGINE=MyISAM  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;";
         $DB->query($query) or die ($DB->error());
      }
   }

   public static function uninstall() {
      global $DB;
      $DB->query("DROP TABLE IF EXISTS `glpi_plugin_openvas_vulnerabilitycategories`");
   }
}
